# How bun-dts Works

bun-dts is a tool for bundling TypeScript declaration files (`.d.ts`) using a clever source transformation approach that bypasses TypeScript compiler limitations.

## Core Process

```
TypeScript Source Files â†’ .d.ts Files â†’ Fake JavaScript â†’ Bundled JS â†’ Single .d.ts File
       â”‚                    â”‚               â”‚               â”‚              â”‚
       â”‚                    â”‚               â”‚               â”‚              â”‚
       â–¼                    â–¼               â–¼               â–¼              â–¼
    Original           Generated by      Type info       Tree-shaking    Final
  source code         Oxc (not tsc)    stored as strings   by Bun      declaration
```

1. Generate `.d.ts` files from TypeScript source using Oxc's `isolatedDeclaration`
2. Convert `.d.ts` files to fake JavaScript (preserving type information as strings)
3. Let Bun bundle this JavaScript (applying tree-shaking)
4. Convert the bundled JavaScript back to a single `.d.ts` file

## Example Transformation

### Starting Point (Project Structure)

```
src/
  types.ts      // defines User interface and unused Admin interface
  utils.ts      // uses User, exports greet function
  index.ts      // re-exports greet
```

### Phase 1: Generate .d.ts from TypeScript Source

Using Oxc's `isolatedDeclaration`:

```ts
// Generated from types.ts
export interface User {
	id: string;
	name: string;
}

export interface Admin {  // This interface is never imported or used
	id: string;
	name: string;
	permissions: string[];
}

// Generated from utils.ts
import type { User } from './types';
export declare function greet(user: User): string;
```

### Phase 2: Transform .d.ts to Fake JavaScript

The clever part - declarations become JS arrays with strings:

```js
// Fake JS for types.ts
export var User = ['interface User { id: string; name: string; }'];
export var Admin = ['interface Admin { id: string; name: string; permissions: string[]; }'];

// Fake JS for utils.ts
import { User } from './types';
export var greet = ['declare function greet(user: User): string;', User];
```

Notice how `User` is included in the array - this preserves type dependencies for tree-shaking.

### Phase 3: Bundle with Bun

Bun bundles the fake JavaScript:

```js
// Bundled fake JS output
var User = ['interface User { id: string; name: string; }'];
var greet = ['declare function greet(user: User): string;', User];
export { greet };
// Note: The Admin interface was tree-shaken out as it's never used
```

### Phase 4: Transform Back to .d.ts

Converting the bundled fake JS to a proper declaration file:

```ts
// dist/index.d.ts
interface User {
	id: string;
	name: string;
}

declare function greet(user: User): string;

export { greet };
// Admin interface isn't included since it was tree-shaken out
```

## TL;DR â€” Runtime Process

| Step                    | What Happens                       |
| ----------------------- | ---------------------------------- |
| entry.ts provided       | Starts Bun build                   |
| Plugin resolves modules | Bun resolves imports recursively   |
| onLoad hook hit         | Each .ts â†’ .d.ts via oxc â†’ fake-js |

## Key Benefits

- **âš¡ Speed**: Orders of magnitude faster than tsc-based approaches
- **ðŸŒ³ Tree-shaking**: Only used types appear in the output
- **ðŸ“¦ Single file**: Clean, self-contained declaration bundle
- **ðŸ’ª Robustness**: Handles complex type dependencies reliably
- **ðŸ”„ Circular references**: Works with circular type references
