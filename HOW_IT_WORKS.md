# How bun-dts Works

bun-dts is a tool for bundling TypeScript declaration files (`.d.ts`) using a clever source transformation approach that bypasses TypeScript compiler limitations.

## Core Process

```
TypeScript Source Files â†’ .d.ts Files â†’ Fake JavaScript â†’ Bundled JS â†’ Single .d.ts File
       â”‚                    â”‚               â”‚               â”‚              â”‚
       â”‚                    â”‚               â”‚               â”‚              â”‚
       â–¼                    â–¼               â–¼               â–¼              â–¼
    Original           Generated by      Type info       Tree-shaking    Final
  source code         Oxc Transform    stored as tokens    by Bun      declaration
```

1. Generate `.d.ts` files from TypeScript source using Oxc's Transform
2. Convert `.d.ts` files to fake JavaScript (preserving type information as tokenized arrays) using Oxc Parser
3. Let Bun bundle this JavaScript (applying tree-shaking)
4. Convert the bundled JavaScript back to a single `.d.ts` file using Oxc Parser

## Example Transformation

### Starting Point (Project Structure)

```
src/
  types.ts      // defines User interface and unused Admin interface
  utils.ts      // uses User, exports greet function
  index.ts      // re-exports greet
```

### Phase 1: Generate .d.ts from TypeScript Source

Using Oxc's Transform:

```ts
// Generated from types.ts
export interface User {
	id: string;
	name: string;
}

export interface Admin {  // This interface is never imported or used
	id: string;
	name: string;
	permissions: string[];
}

// Generated from utils.ts
import type { User } from './types';
export declare function greet(user: User): string;
```

### Phase 2: Transform .d.ts to Fake JavaScript

Using Oxc Parser, declarations become JS arrays with tokens:

```js
// Fake JS for types.ts
export var User = ["interface ", User, " {", "\n", "\t", "id", ":", " ", "string", ";", " ", "name", ":", " ", "string", ";", "\n", "}"];
export var Admin = ["interface ", Admin, " {", "\n", "\t", "id", ":", " ", "string", ";", " ", "name", ":", " ", "string", ";", " ", "permissions", ":", " ", "string", "[", "]", ";", "\n", "}"];

// Fake JS for utils.ts
import { User } from './types';
export var greet = ["declare ", "function ", greet, "(", "user", ":", " ", User, ")", ":", " ", "string", ";"];
```

Notice how `User` is included in the array as a direct reference - this preserves type dependencies for tree-shaking without needing string manipulation.

### Phase 3: Bundle with Bun

Bun bundles the fake JavaScript:

```js
// Bundled fake JS output
var User = ["interface ", User, " {", "\n", "\t", "id", ":", " ", "string", ";", " ", "name", ":", " ", "string", ";", "\n", "}"];
var greet = ["declare ", "function ", greet, "(", "user", ":", " ", User, ")", ":", " ", "string", ";"];
export { greet };
// Note: The Admin interface was tree-shaken out as it's never used
```

### Phase 4: Transform Back to .d.ts

Using Oxc Parser to convert the bundled fake JS to a proper declaration file:

```ts
// dist/index.d.ts
interface User {
	id: string;
	name: string;
}

declare function greet(user: User): string;

export { greet };
// Admin interface isn't included since it was tree-shaken out
```

## TL;DR â€” Runtime Process

| Step                    | What Happens                       |
| ----------------------- | ---------------------------------- |
| entry.ts provided       | Starts Bun build                   |
| Plugin resolves modules | Bun resolves imports recursively   |
| onLoad hook hit         | Each .ts â†’ .d.ts via oxc â†’ fake-js |

## Key Benefits

- **âš¡ Speed**: Orders of magnitude faster than tsc-based approaches
- **ðŸŒ³ Tree-shaking**: Only used types appear in the output
- **ðŸ“¦ Single file**: Clean, self-contained declaration bundle
- **ðŸ’ª Robustness**: Handles complex type dependencies reliably
